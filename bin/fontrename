#!/usr/bin/env -S fontforge -quiet
# -*- mode: python; coding: utf-8 -*-
import os, sys, errno, argparse
sys.path.append(os.path.dirname(__file__) + "/../lib")
import silence

dry_run = False

def main():
    global args
    parser = argparse.ArgumentParser(description="rename one or more fonts using PS names")
    parser.add_argument('filenames', nargs='+')
    parser.add_argument('-n', '--dry-run', action='store_true', help="don't take actions, only print them")
    parser.add_argument('-d', '--directories', action='store_true', help="move fonts into font-family subdirectories")
    args = parser.parse_args()

    exit_code = 0
    for filename in args.filenames:
        try:
            silence.on()
            font = fontforge.open(filename)
        except OSError as e:
            if str(e) == 'Open failed':
                exit_code = 1
                print("%s: format error or not a font" % filename)
                continue
            raise e
        finally:
            silence.off()
        (dirname, basename) = os.path.split(filename)
        (baseroot, baseext) = os.path.splitext(basename)

        if args.directories:
            new_filename = os.path.join(dirname, font.familyname, font.fontname + baseext)
        else:
            new_filename = os.path.join(dirname, font.fontname + baseext)

        if filename == new_filename:
            print("%s: not renaming" % (filename,))
            font.close()
            continue
        if exists(new_filename):
            exit_code = 1
            print("%s: %s already exists" % (filename, new_filename))
            font.close()
            continue
        if args.directories:
            dirname = os.path.dirname(new_filename)
            if exists(dirname):
                if not os.path.isdir(dirname):
                    exit_code = 1
                    print("%s: %s is not a directory" % (filename, repr(dirname)))
                    font.close()
                    continue
            else:
                if args.dry_run:
                    print("mkdir %s" % dirname)
                else:
                    os.mkdir(dirname)
        if args.dry_run:
            print("mv %s %s" % (filename, new_filename))
        else:
            try:
                os.rename(filename, new_filename)
            except e:
                print(str(e))
                exit_code = 1
                font.close()
                continue
        font.close()

def exists(filename):
    try:
        stat = os.stat(filename)
        return True
    except OSError as e:
        if e.errno == errno.ENOENT:
            return False
        raise e

main()
